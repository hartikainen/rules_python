#!/bin/bash


# set -euo pipefail

PATH_TO_COMPARE=${1:-lib/python3.12/site-packages/nvidia}

echo "Comparing contents of '$PATH_TO_COMPARE' between ./.venv and bazel-bin/test.runfiles/_main/_test.venv"

mkdir -p "$HOME/.cache/diff/${PATH_TO_COMPARE%/*}"

tree \
  -I '__pycache__|*.pyc' \
  ./.venv/$PATH_TO_COMPARE \
  > ~/.cache/venv-site-packages.txt
tree \
  -l \
  -I '__pycache__|*.pyc' \
  ./bazel-bin/test.runfiles/_main/_test.venv/$PATH_TO_COMPARE \
  | sed 's/ -> .*//' \
  > ~/.cache/bazel-site-packages.txt
diff \
  -u \
  ~/.cache/venv-site-packages.txt \
  ~/.cache/bazel-site-packages.txt \
  > "$HOME/.cache/diff/$PATH_TO_COMPARE.diff"

echo "Diff written to $HOME/.cache/diff/$PATH_TO_COMPARE.diff"
echo "Diff content:"
cat "$HOME/.cache/diff/$PATH_TO_COMPARE.diff"
